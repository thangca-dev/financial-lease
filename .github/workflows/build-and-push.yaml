name: Build and Push Changed Services
on:
  push:
    branches: [main]
    paths:
      - "apps/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/build-and-push.yaml"

permissions:
  id-token: write
  contents: read
  packages: write

env:
  INFRA_REPO: thangca-dev/financial-lease-stack

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_services: ${{steps.filter.outputs.changes}}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 2 # ensures HEAD^

      - name: Detect changed services
        id: filter
        run: |
          echo "Detecting changed services..."
          if git rev-parse HEAD^ > /dev/null 2>&1; then
            base_commit=$(git rev-parse HEAD^)
          else
            echo "No previous commit found, comparing against initial state"
            base_commit=$(git hash-object -t tree /dev/null)
          fi
          # Detect changed apps under /apps
          changes=$(git diff --name-only "$base_commit" HEAD | grep '^apps/' || true)
          changed=$(echo "$changes" \
            | awk -F'/' '{print $2}' \
            | grep -v '^$' \
            | sort -u \
            | jq -R . \
            | jq -s -c .)
          if [ -z "$changed" ] || [ "$changed" = "[]" ]; then
            changed="[]"
          fi
          echo "Detected changed services: $changed"
          echo "changes=$changed" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.changed_services != '[]' && needs.detect-changes.outputs.changed_services != '' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed_services) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{secrets.AWS_ACCOUNT_ID}}:role/github-actions-ecr
          aws-region: ${{secrets.AWS_REGION}}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup PNPM
        run: |
          npm install -g corepack@latest
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install dependencies (with cache)
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false
        continue-on-error: false

      - name: Generate image tag
        id: vars
        run: |
          IMAGE_TAG=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ matrix.service }}:$IMAGE_TAG"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "Built image tag: $IMAGE_URI"

      - name: Build and Push image
        env:
          SERVICE: ${{matrix.service}}
        run: |
          echo "Building and pushing $SERVICE..."
          docker buildx build . \
          -f apps/${SERVICE}/Dockerfile \
          -t $IMAGE_URI \
          --platform linux/amd64 \
          --push

      - name: Output image details
        run: |
          echo "Built and pushed: $IMAGE_URI"

      - name: Clear AWS credentials after use
        run: |
          unset AWS_ACCESS_KEY_ID
          unset AWS_SECRET_ACCESS_KEY
          unset AWS_SESSION_TOKEN

      - name: Notify FluxCD (auto-deploy)
        env:
          TOKEN: ${{ secrets.CI_CD_GITHUB_PERSONAL_ACCESS_TOKEN_ORG }}
          SERVICE: ${{matrix.service}}
          ENVIRONMENT: ${{inputs.environment || 'dev'}}
          TENANT: ${{inputs.tenant || 'default'}}
        run: |
          echo "Triggering Flux update for $SERVICE..."
          echo "Environment: $ENVIRONMENT"
          echo "Token: $TOKEN"
          EVENT_TYPE="update-deployments"
          PAYLOAD=$(jq -n \
          --arg event_type "$EVENT_TYPE" \
          --arg service "$SERVICE" \
          --arg version "${IMAGE_TAG}" \
          --arg env "${ENVIRONMENT}" \
          --arg tenant "$TENANT" \
          '{event_type: $event_type, client_payload: {service: $service, version: $version, env: $env, tenant: $tenant}}')

          echo "Dispatch payload:"
          echo "$PAYLOAD"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{env.INFRA_REPO}}/dispatches \
            -d "$PAYLOAD"
